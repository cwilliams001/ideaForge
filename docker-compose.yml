# Idea Forge - Docker Compose with Tailscale
#
# Access via Tailscale at: https://ts-ideaforge.<your-tailnet>.ts.net
#
# Setup:
#   1. Copy .env.example to .env and configure
#   2. Set TS_AUTHKEY (get from Tailscale admin console)
#   3. Set OBSIDIAN_VAULT_PATH to your Syncthing vault on the host
#   4. Run: docker compose up -d

services:
  # Tailscale sidecar - provides network access via Tailscale
  ts-ideaforge:
    image: tailscale/tailscale:latest
    container_name: ts-ideaforge
    hostname: ts-ideaforge
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_EXTRA_ARGS=--advertise-tags=tag:container
      - TS_SERVE_CONFIG=/config/serve.json
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
    volumes:
      - ./tailscale-state:/var/lib/tailscale
      - ./tailscale-config:/config
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - net_admin
      - sys_module
    restart: unless-stopped

  # Frontend - Next.js PWA
  # Note: NEXT_PUBLIC_API_URL is set to empty string at build time in Dockerfile
  # This makes the frontend use relative URLs, which Tailscale proxies to backend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: ideaforge-frontend
    network_mode: service:ts-ideaforge
    depends_on:
      - ts-ideaforge
      - backend
    restart: unless-stopped

  # Backend - Go API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ideaforge-backend
    network_mode: service:ts-ideaforge
    depends_on:
      - ts-ideaforge
    environment:
      - PORT=8080
      - DATABASE_PATH=/app/data/ideaforge.db
      - OBSIDIAN_VAULT_PATH=/obsidian
      - OBSIDIAN_FOLDER=${OBSIDIAN_FOLDER:-IdeaForge}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - LLM_MODEL=${LLM_MODEL:-claude-sonnet-4-20250514}
      - SEARXNG_URL=${SEARXNG_URL:-}
    volumes:
      - backend-data:/app/data
      # Mount the Obsidian vault from host (where Syncthing syncs to)
      # Example: /home/ansible/syncthing/sync/Obsidian
      - ${OBSIDIAN_VAULT_PATH}:/obsidian
    restart: unless-stopped

volumes:
  backend-data:
